<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>4×4 Generative Music Grid</title>
  <script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #222;
    }
    .grid {
      display: grid;
      grid-template-rows: repeat(5, 100px);
      grid-template-columns: repeat(4, 100px);
      grid-gap: 10px;
    }
    .cell {
      width: 100px;
      height: 100px;
      background: #444;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 2.5em;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
    }
    .cell.state-1 { background: #5a5; transform: rotate(90deg); }
    .cell.state-2 { background: #55a; transform: rotate(180deg); }
    .cell.state-3 { background: #a55; transform: rotate(270deg); }
    .reset-button {
      position: absolute;
      bottom: 20px;
      padding: 10px 20px;
      background: #666;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.2s;
    }
    .reset-button:hover {
      background: #888;
    }
    .step-counter {
      position: absolute;
      top: 20px;
      color: white;
      font-size: 1.5em;
      font-family: monospace;
    }
    .toggle-button {
      position: absolute;
      bottom: 60px;
      padding: 10px 20px;
      background: #666;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.2s;
    }
    .toggle-button:hover {
      background: #888;
    }
    .toggle-button.active {
      background: #5a5;
    }
  </style>
</head>
<body>
  <div class="step-counter" id="stepCounter">Step: 0</div>
  <div class="grid" id="grid"></div>
  <button class="reset-button" id="reset">Reset</button>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Transport: 86 bpm, 4‑bar loop
    Tone.Transport.bpm.value = 86;
    Tone.Transport.loop = true;
    Tone.Transport.loopEnd = '4m';

    const cells = []; // Store all cell instances
    const stepCounter = document.getElementById('stepCounter');
    let isArpeggioEnabled = false;
    let arpeggioIndex = 0;

    // Create a single shared PolySynth with voice management
    const sharedSynth = new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: 'sine' },
      envelope: { 
        attack: 0.1, 
        decay: 0.1,
        sustain: 0.1,
        release: 0.2 
      },
      maxPolyphony: 8 // Limit to 8 simultaneous voices
    });

    // Add volume control and compression
    const gain = new Tone.Gain(0.4).toDestination();
    const compressor = new Tone.Compressor({
      threshold: -20,
      ratio: 8,
      attack: 0.003,
      release: 0.25
    });

    // Add digital delay
    const delay = new Tone.FeedbackDelay({
      delayTime: 0.25,  // 1/4 note delay
      feedback: 0.5,    // 50% feedback
      wet: 0.3         // 30% wet signal
    });

    // Connect the audio chain
    sharedSynth.chain(delay, compressor, gain);

    // Track last note played globally
    let lastGlobalNote = null;

    // Update step counter every 16th note
    Tone.Transport.scheduleRepeat((time) => {
      const position = Tone.Transport.position.split(':');
      const step = parseInt(position[1]) + 1; // Convert to 1-based counting
      stepCounter.textContent = `Step: ${step}`;
    }, '16n');

    class Cell {
      constructor(row, col, el) {
        this.row = row;
        this.col = col;
        this.el = el;
        this.state = 0;      // 0–3
        this.part = new Tone.Part((time, note) => {
          // convert MIDI to Hz
          const freq = Tone.Frequency(note, 'midi').toFrequency();
          sharedSynth.triggerAttackRelease(freq, '8n', time);
          // Update global last note
          lastGlobalNote = note;
        }, []).start(0);
        this.updateVisual();
      }
      advanceState() {
        this.state = (this.state + 1) % 4;
        this.updatePart();
        this.updateVisual();
      }
      updateVisual() {
        this.el.className = 'cell state-' + this.state;
        this.el.textContent = '↑';
      }
      updatePart() {
        this.part.clear();
        if (this.state === 0) return; // Don't schedule anything for state 0
        
        const note = getPitch(this.row, this.state, this.lastNote);
        // Schedule note to play on this column's step in each bar
        for (let bar = 0; bar < 4; bar++) {
          // Format: "bar:step:subdivision"
          // this.col is 0-3, which corresponds to steps 1-4
          const time = `${bar}:${this.col}:0`;
          this.part.add(time, note);
        }
        this.lastNote = note;
      }
    }

    // 4‑step pattern per bar (quarter‑note grid)
    function getRhythmPattern(state) {
      if (state === 1) return [1, 0, 0, 0];
      if (state === 2) return [1, 0, 1, 0];
      if (state === 3) return [1, 1, 1, 1];
      return [0, 0, 0, 0];
    }

    // Map row→scale degree; 4 states→pitch choices + voice leading
    function getPitch(row, state, last) {
      const C4 = Tone.Frequency('C4').toMidi();
      const scale = [0, 2, 4, 5, 7, 9, 11]; // C major scale
      const root = C4 + scale[row];
      if (state === 1) {
        return root;
      }
      if (state === 2) {
        return root + 4;
      }
      if (state === 3) {
        const chord = [root, root + 4, root + 7];
        if (lastGlobalNote == null) return root;
        return chord.reduce((a, b) =>
          Math.abs(b - lastGlobalNote) < Math.abs(a - lastGlobalNote) ? b : a
        );
      }
      // state 0: silent
      return root;
    }

    // build grid
    const gridEl = document.getElementById('grid');
    for (let r = 0; r < 5; r++) {
      for (let c = 0; c < 4; c++) {
        const el = document.createElement('div');
        el.id = `cell-${r}-${c}`;
        el.className = 'cell state-0';
        gridEl.appendChild(el);
        const cell = new Cell(r, c, el);
        cells.push(cell);
        el.addEventListener('click', () => {
          cell.advanceState();
          if (Tone.Transport.state !== 'started') Tone.Transport.start();
        });
      }
    }

    // Add reset functionality
    document.getElementById('reset').addEventListener('click', () => {
      cells.forEach(cell => {
        cell.state = 0;
        cell.updateVisual();
        cell.updatePart();
      });
      Tone.Transport.stop();
    });
  });
  </script>
</body>
</html>
